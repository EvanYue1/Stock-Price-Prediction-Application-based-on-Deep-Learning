<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Prediction</title>
    <!-- 引入 Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<!-- 引入 ECharts -->
<script src="../static/js/echarts.js"></script>
<script src="../static/js/jquery-3.7.1.min.js" type="text/javascript" charset="utf-8"></script>
<!-- 导航栏 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Stock Prediction</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="#">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">About</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Contact</a>
            </li>
        </ul>
    </div>
</nav>

<!-- 主要内容区域 -->
<div class="container mt-4">
    <div class="row">
        <!-- 左侧股票选择区域 -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Select stock and predict</h5>
                    <form id="predictionForm">
                        <div class="form-group">
                            <label for="stockSymbol">Stock Symbol</label>
                            <input type="text" class="form-control" id="stockSymbol" placeholder="input stock symbol">
                        </div>
                        <div class="form-group">
                            <label for="predictionDays">Prediction Days</label>
                            <input type="number" class="form-control" id="predictionDays"
                                   placeholder="input prediction days">
                        </div>
                        <div class="form-group">
                            <label for="predictionUnit">Units</label>
                            <select class="form-control" id="predictionUnit">
                                <option value="days">Day</option>
                                <option value="months">Month</option>
                                <option value="years">Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="model">Select Model</label>
                            <select class="form-control" id="model">
                                <option value="LSTM">LSTM</option>
                                <option value="LSTM_CNN_CBAM">LSTM_CNN_CBAM</option>
                                <option value="LSTM_CNN_Base">LSTM_CNN_Base</option>
                            </select>
                        </div>
                        <!-- 新增的选择预测目标的下拉菜单 -->
                        <div class="form-group" id="predictionTargetGroup" style="display: none;">
                            <label for="predictionTarget">Prediction Target</label>
                            <select class="form-control" id="predictionTarget">
                                <option value="open">Open Price</option>
                                <option value="close">Close Price</option>
                                <option value="high">High Price</option>
                                <option value="low">Low Price</option>
                            </select>
                        </div>
                        <!-- 新增的选择特征的多选框 -->
                        <div class="form-group" id="featureSelectionGroup" style="display: none;">
                            <label for="featureSelection">Choose Features</label><br>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="closeFeature" value="close">
                                <label class="form-check-label" for="closeFeature">Close Price</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="openFeature" value="open">
                                <label class="form-check-label" for="openFeature">Open Price</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="highFeature" value="high">
                                <label class="form-check-label" for="highFeature">High Price</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="lowFeature" value="low">
                                <label class="form-check-label" for="lowFeature">Low Price</label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
                        <div class="container">
                            <h2>Training Progress</h2>
                            <div class="progress">
                                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;"
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%
                                </div>
                            </div>
                        </div>
                        <script>
                            var socket = new WebSocket('ws://' + window.location.host + '/room/progressbar');
                            // when websocket receive message from server, this function will be executed
                            socket.onmessage = function (e) {
                                var data = JSON.parse(e.data);
                                var progress = data.progress;
                                var progressBar = document.getElementById('progress-bar');
                                progressBar.style.width = progress + '%';
                                progressBar.textContent = progress + '%';
                            };
                        </script>
                    </form>
                </div>
            </div>
        </div>
        <!-- 右侧预测结果展示区域 -->
        <!-- 右侧预测结果展示区域 -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Prediction Display</h5>

                    <!-- 第一个图占据一行 -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-heading">Prediction Result</div>
                                <div class="panel-body">
                                    <!-- 这里展示第一个图内容 -->
                                    <div id="chartContainer" style="height: 400px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 第二个图占据一行 -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-heading">Test Result</div>
                                <div class="panel-body">
                                    <!-- 这里展示第二个图内容 -->
                                    <div id="chartContainer_test" style="height: 400px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 第三个图占据一行 -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="panel panel-default">
                                <div class="panel-heading">Validation Results</div>
                                <div class="panel-body">
                                    <!-- 这里展示第三个图内容 -->
                                    <div id="chartContainer_verify" style="height: 400px; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>


    </div>
</div>

<!-- 引入 Bootstrap JavaScript 和 jQuery -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    $(document).ready(function () {
        // 检查默认选择的模型，并根据其值来决定是否显示预测目标的下拉框
        var selectedModel = $('#model').val();
        if (selectedModel === 'LSTM') {
            $('#predictionTargetGroup').show();
            $('#featureSelectionGroup').hide();
        } else if (selectedModel === 'LSTM_CNN_SE' || selectedModel === 'LSTM_CNN_HW' || selectedModel === 'LSTM_CNN_CBAM' || selectedModel === 'LSTM_CNN_Base') {
            $('#predictionTargetGroup').show();
            $('#featureSelectionGroup').show();
        } else {
            $('#predictionTargetGroup').hide();
            $('#featureSelectionGroup').hide();
        }
        // 当模型选择改变时，显示或隐藏预测目标选项
        $('#model').change(function () {
            var selectedModel = $(this).val();
            if (selectedModel === 'LSTM') {
                $('#predictionTargetGroup').show();
                $('#featureSelectionGroup').hide();
            } else if (selectedModel === 'LSTM_CNN_SE' || selectedModel === 'LSTM_CNN_HW' || selectedModel === 'LSTM_CNN_CBAM' || selectedModel === 'LSTM_CNN_Base') {
                $('#predictionTargetGroup').show();
                $('#featureSelectionGroup').show();
            } else {
                $('#predictionTargetGroup').hide();
                $('#featureSelectionGroup').hide();
            }
        });

        // 在下拉框选择预测目标时，自动选择对应的多选框
        $('#predictionTarget').change(function () {
            var selectedTarget = $(this).val();
            // 根据预测目标值选择对应的多选框
            $('input[type=checkbox]').prop('checked', false); // 先取消所有多选框的选中状态
            $('#' + selectedTarget + 'Feature').prop('checked', true); // 将对应的多选框设置为选中状态
        });

        // 触发一次预测目标下拉框的 change 事件，以便在页面加载时自动选择对应的多选框
        $('#predictionTarget').change();

        // 在多选框的 change 事件中，防止用户取消预测目标对应的选项
        $('input[type=checkbox]').change(function () {
            var selectedTarget = $('#predictionTarget').val(); // 获取当前预测目标
            var selectedFeature = $(this).val(); // 获取当前选中的多选框的值
            if (selectedFeature === selectedTarget) {
                // 如果当前选中的多选框与预测目标相同，则禁止取消选中状态
                $(this).prop('checked', true);
            }
        });

        var myChart; // 将 myChart 变量定义在外面，以便在函数内部和外部都能访问
        // 通过 AJAX 请求获取后端数据并更新图表
        function updateChartWithData(xAxis, seriesData) {
            // 对 seriesData 中的每个数值保留两位小数
            seriesData = seriesData.map(function (value) {
                return parseFloat(value.toFixed(2));
            });
            if (myChart) {
                myChart.setOption({
                    xAxis: {
                        data: xAxis
                    },
                    series: [{
                        data: seriesData
                    }]
                });
            } else {
                // 初始化 ECharts 实例
                myChart = echarts.init(document.getElementById('chartContainer'));
                // 指定图表的配置项和数据
                var option = {

                    tooltip: {
                        trigger: 'axis'
                    },
                    xAxis: {
                        type: 'category',
                        data: xAxis // 设置横坐标数据
                    },
                    yAxis: {
                        type: 'value',
                        min: 'dataMin', // 设置纵坐标最小值
                        max: 'dataMax'  // 设置纵坐标最大值
                    },
                    series: [{
                        data: seriesData, // 设置纵坐标数据
                        type: 'line'
                    }]
                };

                // 使用刚指定的配置项和数据显示图表
                myChart.setOption(option);
            }
        }

        // 更新第二个图表（绘制两条折线）
        function updateSecondChartWithData(yPred, yTrue) {
            // 对预测值和实际值进行保留两位小数的处理
            yPred = yPred.map(value => Number(value.toFixed(2)));
            yTrue = yTrue.map(value => Number(value.toFixed(2)));
            var secondChart;
            if (secondChart) {
                secondChart.setOption({
                    series: [{
                        name: 'Predicted', // 设置第一条折线的名称
                        data: yPred // 第一条折线数据
                    }, {
                        name: 'Actual', // 设置第二条折线的名称
                        data: yTrue // 第二条折线数据
                    }],
                    legend: { // 添加图例
                        data: ['Predicted', 'Actual']
                    }
                });
            } else {
                secondChart = echarts.init(document.getElementById('chartContainer_test'));
                var option = {

                    tooltip: {
                        trigger: 'axis'
                    },
                    xAxis: {
                        type: 'category', // echarts 自行设定 x 轴数据
                        // data: xAxis // 不设置 x 轴数据
                    },
                    yAxis: {
                        type: 'value',
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    series: [{
                        name: 'Predicted', // 设置第一条折线的名称
                        data: yPred, // 第一条折线数据
                        type: 'line'
                    }, {
                        name: 'Actual', // 设置第二条折线的名称
                        data: yTrue, // 第二条折线数据
                        type: 'line'
                    }],
                    legend: { // 添加图例
                        data: ['Predicted', 'Actual']
                    }
                };
                secondChart.setOption(option);
            }
        }

        // 更新第二个图表（绘制两条折线）
        function updateThirdChartWithData(combined_verify_dates, combined_verify_data, combined_verify_true_data) {
            // 对预测值和实际值进行保留两位小数的处理
            combined_verify_data = combined_verify_data.map(value => Number(value.toFixed(2)));
            combined_verify_true_data = combined_verify_true_data.map(value => Number(value.toFixed(2)));
            var secondChart;
            if (secondChart) {
                secondChart.setOption({
                    xAxis: {
                        data: combined_verify_dates // 设置横坐标数据
                    },
                    series: [{
                        name: 'Predicted', // 设置第一条折线的名称
                        data: combined_verify_data // 第一条折线数据
                    }, {
                        name: 'Actual', // 设置第二条折线的名称
                        data: combined_verify_true_data // 第二条折线数据
                    }]
                });
            } else {
                secondChart = echarts.init(document.getElementById('chartContainer_verify'));
                var option = {

                    tooltip: {
                        trigger: 'axis'
                    },
                    xAxis: {
                        type: 'category',
                        data: combined_verify_dates // 设置横坐标数据
                    },
                    yAxis: {
                        type: 'value',
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    series: [{
                        name: 'Predicted', // 设置第一条折线的名称
                        data: combined_verify_data, // 第一条折线数据
                        type: 'line'
                    }, {
                        name: 'Actual', // 设置第二条折线的名称
                        data: combined_verify_true_data, // 第二条折线数据
                        type: 'line'
                    }],
                    legend: { // 添加图例
                        data: ['Predicted', 'Actual']
                    }
                };
                secondChart.setOption(option);
            }
        }


        $('#predictionForm').submit(function (e) {
            e.preventDefault();
            var stockSymbol = $('#stockSymbol').val().trim();
            var predictionDays = $('#predictionDays').val();
            var predictionUnit = $('#predictionUnit').val();
            var model = $('#model').val();
            var predictionTarget = $('#predictionTarget').val(); // 获取预测目标
            var selectedFeatures = []; // 用于存储用户选择的特征

            // 遍历多选框，收集用户选择的特征
            $('input[type=checkbox]:checked').each(function () {
                selectedFeatures.push($(this).val());
            });

            // 简单验证
            if (stockSymbol === '') {
                alert('Please enter a stock symbol.');
                return;
            }
            if (isNaN(predictionDays) || predictionDays <= 0) {
                alert('Please enter a valid prediction days.');
                return;
            }

            // 发送 AJAX 请求
            $.ajax({
                type: 'POST',
                url: 'http://localhost:8000/predict/', // 后端处理请求的URL
                data: {
                    stockSymbol: stockSymbol,
                    predictionDays: predictionDays,
                    predictionUnit: predictionUnit,
                    model: model,
                    predictionTarget: predictionTarget, // 将预测目标添加到数据中
                    selectedFeatures: selectedFeatures // 将用户选择的特征添加到数据中
                },

                success: function (response) {
                    // 处理成功响应
                    console.log('Prediction successful:', response);
                    // 在页面上显示预测结果，这里可以根据后端返回的数据格式进行处理
                    $('#predictionResult').html('<p>' + response + '</p>');
                    // 更新图表
                    updateChartWithData(response.combined_dates, response.combined_data);
                    // 更新第二个图表
                    updateSecondChartWithData(response.y_pred_inv, response.y_true_inv);
                    // 更新第三个图标
                    updateThirdChartWithData(response.combined_verify_dates, response.combined_verify_data, response.combined_verify_ture_data)
                },
                error: function (xhr, status, error) {
                    // 处理请求失败
                    console.error('Error:', error);
                    // 可以在页面上显示错误信息或者执行其他操作
                    $('#predictionResult').html('<p>Failed to predict.</p>');
                }
            });
        });
    });


</script>
</body>
</html>


